openapi: 3.0.3
info:
  title: Todo AI Chatbot API
  description: Natural language task management through conversational AI interface
  version: 1.0.0
  contact:
    name: Hackathon II Team

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://api.example.com
    description: Production server

tags:
  - name: chat
    description: Chat endpoints for AI-powered task management

paths:
  /api/{user_id}/chat:
    post:
      tags:
        - chat
      summary: Send message to AI chatbot
      description: |
        Sends a natural language message to the AI chatbot for task management.
        The chatbot interprets the user's intent and performs appropriate actions
        (create, view, complete, update, or delete tasks) through MCP tools.

        The endpoint is stateless - conversation history is fetched from the database
        on each request. Provide a conversation_id to continue an existing conversation,
        or omit it to start a new one.
      operationId: chat
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: The unique identifier of the user
          example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              new_conversation:
                summary: Start new conversation
                value:
                  message: "Add a task to buy groceries"
              continue_conversation:
                summary: Continue existing conversation
                value:
                  conversation_id: "123e4567-e89b-12d3-a456-426614174000"
                  message: "Mark the first task as done"
              view_tasks:
                summary: View all tasks
                value:
                  conversation_id: "123e4567-e89b-12d3-a456-426614174000"
                  message: "Show my pending tasks"
      responses:
        '200':
          description: Successful chat response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
                task_created:
                  summary: Task created successfully
                  value:
                    conversation_id: "123e4567-e89b-12d3-a456-426614174000"
                    response: "I've created a task titled 'buy groceries' for you."
                    tool_calls:
                      - tool: "add_task"
                        status: "success"
                        task_id: 42
                tasks_viewed:
                  summary: Tasks listed
                  value:
                    conversation_id: "123e4567-e89b-12d3-a456-426614174000"
                    response: "You have 3 pending tasks: 1) buy groceries, 2) call dentist, 3) finish report"
                    tool_calls:
                      - tool: "list_tasks"
                        status: "success"
                        count: 3
                clarification_needed:
                  summary: Ambiguous task reference
                  value:
                    conversation_id: "123e4567-e89b-12d3-a456-426614174000"
                    response: "I see multiple tasks that could match. Which task would you like to mark as done - the one about groceries, dentist, or report?"
                    tool_calls: []
        '400':
          description: Bad request - invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                empty_message:
                  summary: Empty message
                  value:
                    error: "validation_error"
                    message: "Message cannot be empty"
                    detail: "Field 'message' requires at least 1 character"
                invalid_conversation:
                  summary: Invalid conversation ID
                  value:
                    error: "validation_error"
                    message: "Invalid conversation_id format"
                    detail: "Field 'conversation_id' must be a valid UUID"
        '401':
          description: Unauthorized - missing or invalid authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "unauthorized"
                message: "Authentication required"
                detail: "Valid JWT token must be provided in Authorization header"
        '403':
          description: Forbidden - conversation belongs to different user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "access_denied"
                message: "Conversation access denied"
                detail: "You do not have permission to access this conversation"
        '404':
          description: Not found - conversation does not exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "not_found"
                message: "Conversation not found"
                detail: "The specified conversation_id does not exist"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "internal_error"
                message: "An unexpected error occurred"
                detail: "Failed to process chat request"
        '503':
          description: Service unavailable - agent execution timeout
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "timeout"
                message: "Agent execution timed out"
                detail: "Request processing exceeded 30 second limit"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from Better Auth authentication

  schemas:
    ChatRequest:
      type: object
      required:
        - message
      properties:
        conversation_id:
          type: string
          format: uuid
          description: Existing conversation ID (omit to start new conversation)
          example: "123e4567-e89b-12d3-a456-426614174000"
        message:
          type: string
          minLength: 1
          maxLength: 10000
          description: User's natural language message
          example: "Add a task to call the dentist tomorrow at 3pm"
      additionalProperties: false

    ChatResponse:
      type: object
      required:
        - conversation_id
        - response
        - tool_calls
      properties:
        conversation_id:
          type: string
          format: uuid
          description: Conversation ID (new or existing)
          example: "123e4567-e89b-12d3-a456-426614174000"
        response:
          type: string
          description: AI assistant's natural language response
          example: "I've created a task titled 'call the dentist' for tomorrow at 3pm."
        tool_calls:
          type: array
          description: List of MCP tools invoked during agent execution
          items:
            type: object
            properties:
              tool:
                type: string
                description: Name of the MCP tool that was called
                example: "add_task"
              status:
                type: string
                enum: [success, error]
                description: Whether the tool execution succeeded
                example: "success"
              task_id:
                type: integer
                description: ID of affected task (if applicable)
                example: 42
              error:
                type: string
                description: Error message if tool execution failed
                example: "Task not found"
      additionalProperties: false

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code (machine-readable)
          example: "validation_error"
          enum:
            - validation_error
            - unauthorized
            - access_denied
            - not_found
            - internal_error
            - timeout
        message:
          type: string
          description: Human-readable error message
          example: "Invalid request parameters"
        detail:
          type: string
          description: Additional error details
          example: "Field 'message' is required and cannot be empty"
      additionalProperties: false
